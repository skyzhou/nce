/*! nce-qnml 2014-07-25 */
(function(){var t={},e="        ",n=!1,r='.ce-wrap{border: 1px solid #ccc;position: relative;}.ce-dis,.ce-ipt{line-height: 18px;white-space: pre;height: 80px;font-size: 12px;padding: 0px;margin: 0px;word-wrap:break-word;border: 0px;}.ce-dis{z-index: 222;pointer-events:none;position: absolute;top:0px;left: 0px;text-shadow:0 0 5px #fff;font-family: Consolas, "Liberation Mono", Courier, monospace;}.ce-ipt{outline: none; resize:none;background-color: transparent; overflow: hidden;color: #000;margin-left: 40px;border-left:1px solid #ccc;padding-left:10px;vertical-align:bottom;font-family: Nce,Consolas, "Liberation Mono", Courier, monospace;}';window.nce={create:function(e,i,s){if(window.qnml){n||qnml.insertStyle(r);var o=this,a={width:800,height:180,raw:""};s=s||{};for(var l in s)a[l]=s[l];var c=document.createElement("div"),u=document.createElement("div"),h=document.createElement("textarea");c.className="ce-wrap",u.className="ce-dis",h.className="ce-ipt",h.setAttribute("spellcheck","false"),c.appendChild(u),c.appendChild(h),c.style.width=a.width+"px",u.style.width=a.width-2+"px",h.style.width=a.width-52+"px","pointer-events"in document.documentElement.style||(h.style.position="relative",h.style.zIndex="999"),e.appendChild(c),nce.addEvt.call(h,"keydown",function(e){var n=e.keyCode,r=this.value,i=nce.getInputSelection.call(this),s=i.selectionStart,a=i.selectionEnd,l={start:s,end:a,str:r,evt:e,str1:r.substr(0,s),str2:r.substr(a)},c=t[n];if(c){var u=c.call(l,this);if(u)return this.value=u.str,nce.setInputSelection.call(this,{selectionStart:u.start,selectionEnd:u.end}),o.render(),!0}}),"oninput"in h?nce.addEvt.call(h,"input",function(){o.render()}):nce.addEvt.call(h,"keyup",function(){o.render()}),this.id=+new Date,this.language="qnml:code-"+i,this.wrapEl=c,this.displayEl=u,this.inputEl=h,this.setRaw(a.raw,0)}},addKey:function(e,n){t[e]=n},addEvt:function(t,e){var n=function(t){e.call(t.target||t.srcElement,t)&&(t.preventDefault?t.preventDefault():t.returnValue=!1)};this.addEventListener?this.addEventListener(t,n):this.attachEvent("on"+t,n)},getInputSelection:function(){if("selectionStart"in this)return{selectionStart:this.selectionStart,selectionEnd:this.selectionEnd};var t=document.selection.createRange().getBookmark(),e=this.createTextRange(),n=this.value.length;e.moveToBookmark(t);var r=-e.moveStart("character",-n),i=-e.moveEnd("character",-n);return{selectionStart:r,selectionEnd:i}},setInputSelection:function(t){if("object"!=typeof t&&(t={selectionStart:t,selectionEnd:t}),"selectionStart"in this)this.selectionStart=t.selectionStart,this.selectionEnd=t.selectionEnd;else{var e=this.createTextRange();e.collapse(!0),e.moveStart("character",t.selectionStart),e.moveEnd("character",t.selectionEnd)}},filter:function(t){return t.replace(/\t/g,e).replace(/\r\n/g,"\n")}},nce.create.prototype={getRaw:function(){return this.inputEl.value},setRaw:function(t,e){this.inputEl.value=t,this.render(),void 0===e&&(e=t.length),nce.setInputSelection.call(this.inputEl,e)},render:function(){var t=new Date,e=this.inputEl.value+"\n ";this.displayEl.innerHTML=qnml.parse(e,this.language),this.inputEl.style.height=this.displayEl.scrollHeight+"px",console.log("渲染时间",new Date-t)}},nce.addKey(8,function(){if(/^\s{4}$/.test(this.str1.substring(this.start-4,this.start))){var t=[this.str1.substr(0,this.start-4),this.str2].join(""),e=this.start-4;return{start:e,end:e,str:t}}}),nce.addKey(9,function(){if(this.start==this.end){var t=[this.str1,e,this.str2].join(""),n=this.start+e.length;return{start:n,end:n,str:t}}var r,i=0,s=!1;r=this.str1.lastIndexOf("\n"),0>r&&(r=0,s=!0);var o=this.str1.substring(r,this.end).replace(/\S.*/,"").replace(/[^ ]/g,"");if(this.evt.shiftKey){var a=this.str.substring(r,this.end).replace(/\n( {1,4})/g,function(t,e){return i+=e.length,"\n"});s&&(a=a.replace(/^( {1,4})/,function(t,e){return i+=e.length,""}));var t=[this.str1.substr(0,r),a,this.str2].join("");return{start:this.start-Math.min(o.length,4),end:this.end-i,str:t}}var t=[s?e:this.str1.substr(0,r),this.str.substring(r,this.end-1).replace(/\n/g,function(){return i+=e.length,"\n"+e}),this.str.substr(this.end-1)].join("");return{start:this.start+e.length,end:this.end+i+(s?e.length:0),str:t}}),nce.addKey(13,function(){var t=this.str1.substr(this.str1.lastIndexOf("\n")+1).replace(/\S.*/,""),n="";"{"==this.str1.substr(-1)?("}"==this.str2.substr(0,1)&&(n="\n"+t),t+=e):/\/\*+/.test(this.str1.substr(-3))?t+=" *":"*"==this.str1.substr(-1)?t+="*":/\*\//.test(this.str1.substr(-2))&&(t=t.replace(/ $/,""));var r=[this.str1,"\n",t,n,this.str2].join(""),i=this.start+t.length+1;return{start:i,end:i,str:r}})})();