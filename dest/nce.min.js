/*! nce-qnml 2014-07-25 */
(function(){function t(e,n,i){var r=e.lastIndexOf(n);if(0>r)return r;var s=e.substr(r+1);return s.split(n).length==s.split(i).length?r:t(e.substring(0,r),n,i)}var e={},n="        ",i=!1,r='.ce-wrap{border: 1px solid #ccc;position: relative;}.ce-dis,.ce-ipt{line-height: 18px;white-space: pre;height: 80px;font-size: 12px;padding: 0px;margin: 0px;word-wrap:break-word;border: 0px;}.ce-dis{z-index: 222;pointer-events:none;position: absolute;top:0px;left: 0px;text-shadow:0 0 5px #fff;font-family: Consolas, "Liberation Mono", Courier, monospace;}.ce-ipt{outline: none; resize:none;background-color: transparent; overflow: hidden;color: #000;margin-left: 40px;border-left:1px solid #ccc;padding-left:10px;vertical-align:bottom;font-family: Nce,Consolas, "Liberation Mono", Courier, monospace;}',s=0;window.nce={create:function(t,n,o){if(window.qnml){i||qnml.insertStyle(r);var a=this,l={width:1e3,height:180,raw:""};o=o||{};for(var u in o)l[u]=o[u];var c=document.createElement("div"),h=document.createElement("div"),p=document.createElement("textarea");c.className="ce-wrap",h.className="ce-dis",p.className="ce-ipt",p.setAttribute("spellcheck","false"),c.appendChild(h),c.appendChild(p),c.style.width=l.width+"px",h.style.width=l.width-2+"px",p.style.width=l.width-52+"px","pointer-events"in document.documentElement.style||(p.style.position="relative",p.style.zIndex="999"),t.appendChild(c),nce.addEvt.call(p,"keydown",function(t){var n=t.keyCode,i=e[n];if(i){var r=this.value.replace(/\r\n/g,"\n"),o=nce.getInputSelection.call(this),l=o.selectionStart,u=o.selectionEnd,c={start:l,end:u,str:r,evt:t,str1:r.substr(0,l),str2:r.substr(u)},h=i.call(c,this);if(h)return this.value=h.str.replace(/\r\n/g,"\n"),nce.setInputSelection.call(this,{selectionStart:h.start,selectionEnd:h.end}),a.render(),s=1,!0}}),"oninput"in p?nce.addEvt.call(p,"input",function(){a.render()}):nce.addEvt.call(p,"keyup",function(){return s?(s=0,void 0):(a.render(),void 0)}),this.id=+new Date,this.language="qnml:"+n,this.wrapEl=c,this.displayEl=h,this.inputEl=p,this.setRaw(l.raw,0)}},addKey:function(t,n){e[t]=n},addEvt:function(t,e){var n=function(t){var n=t||window.event;e.call(n.target||n.srcElement,n)&&(n.preventDefault?n.preventDefault():n.returnValue=!1)};this.addEventListener?this.addEventListener(t,n):this.attachEvent("on"+t,n)},getInputSelection:function(){if("selectionStart"in this)return{selectionStart:this.selectionStart,selectionEnd:this.selectionEnd};var t=document.selection.createRange().getBookmark(),e=this.createTextRange(),n=this.value.replace(/\r\n/g,"\n").length;e.moveToBookmark(t);var i=-e.moveStart("character",-n),r=-e.moveEnd("character",-n);return{selectionStart:i,selectionEnd:r}},setInputSelection:function(t){if("object"!=typeof t&&(t={selectionStart:t,selectionEnd:t}),"selectionStart"in this)this.selectionStart=t.selectionStart,this.selectionEnd=t.selectionEnd;else{var e=this.createTextRange();e.moveStart("character",t.selectionStart),e.collapse(),e.select()}}},nce.create.prototype={getRaw:function(){return this.inputEl.value},setRaw:function(t,e){this.inputEl.value=t,this.render(),void 0===e&&(e=t.length),nce.setInputSelection.call(this.inputEl,e)},setLanuage:function(t){this.language="qnml:"+t},getLanuage:function(){return this.language.replace("qnml:","")},render:function(){var t=this.inputEl.value+"\n ",e=qnml.parse(t,this.language);this.displayEl.innerHTML=e,this.inputEl.style.height=this.displayEl.scrollHeight+"px"}},nce.addKey(8,function(){if(/^\s{8}$/.test(this.str1.substring(this.start-8,this.start))){var t=[this.str1.substr(0,this.start-8),this.str2].join(""),e=this.start-8;return{start:e,end:e,str:t}}}),nce.addKey(9,function(){if(this.start==this.end){var t=[this.str1,n,this.str2].join(""),e=this.start+n.length;return{start:e,end:e,str:t}}var i,r=0,s=!1;i=this.str1.lastIndexOf("\n"),0>i&&(i=0,s=!0);var o=this.str1.substring(i,this.end).replace(/\S.*/,"").replace(/[^ ]/g,"");if(this.evt.shiftKey){var a=this.str.substring(i,this.end).replace(/\n( {1,4})/g,function(t,e){return r+=e.length,"\n"});s&&(a=a.replace(/^( {1,4})/,function(t,e){return r+=e.length,""}));var t=[this.str1.substr(0,i),a,this.str2].join("");return{start:this.start-Math.min(o.length,4),end:this.end-r,str:t}}var t=[s?n:this.str1.substr(0,i),this.str.substring(i,this.end-1).replace(/\n/g,function(){return r+=n.length,"\n"+n}),this.str.substr(this.end-1)].join("");return{start:this.start+n.length,end:this.end+r+(s?n.length:0),str:t}}),nce.addKey(13,function(){var t=this.str1.substr(this.str1.lastIndexOf("\n")+1).replace(/\S.*/,""),e="",i=this.str1.length;"{"==this.str1.substring(i-1)?("}"==this.str2.substr(0,1)&&(e="\n"+t),t+=n):/\/\*+/.test(this.str1.substring(i-3))?t+=" *":"*"==this.str1.substr(-1)?t+="*":/\*\//.test(this.str1.substring(i-2))&&(t=t.replace(/ $/,""));var r=[this.str1,"\n",t,e,this.str2].join(""),s=this.start+t.length+1;return{start:s,end:s,str:r}}),nce.addKey(221,function(){if(this.evt.shiftKey){var e=this.str1.lastIndexOf("\n"),n=this.str1.substring(e+1,this.start);if(n.length,/^\s*$/.test(n)){var i=this.str1.substring(0,t(this.str1,"{","}")),r=i.substring(i.lastIndexOf("\n")+1,i.length).replace(/\S.*/,""),i=[this.str1.substr(0,e+1),r,"}",this.str2].join(""),s=this.start-(n.length-r.length)+1;return{start:s,end:s,str:i}}}})})();